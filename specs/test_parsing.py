# coding=utf-8
from unittest import TestCase
from gputils.gpparser import GooglePlayResponseParser

class TestParsing(TestCase):
    __CURRENT_RESPONSE_FORMAT = ')]}\'     [[\"ecr\",1,\" \u003cdiv class\u003d\"review-body\"\u003e \u003cspan class\u003d\"review-title\"\u003eGalaxy S5\u003c/span\u003e Paro de funcionar novamente no Estado do Parana \u003cdiv class\u003d\"review-link\" style\u003d\"display:none\"\u003e \u003ca class\u003d\"id-no-nav play-button tiny\" href\u003d\"#\" target\u003d\"_blank\"\u003eResenha completa\u003c/a\u003e \u003c/div\u003e \u003c/div\u003e \u003c/div\u003e  \u003cdiv class\u003d\"single-review\" tabindex\u003d\"0\"\u003e  \u003ca href\u003d\"/store/people/details?id\u003d115501642928986858679\"\u003e \u003cspan class\u003d\"responsive-img-ldpi\"\u003e \u003cspan class\u003d\"responsive-img author-image\" style\u003d\"background-image:url(https://lh3.ggpht.com/-ZjxMcXnTOgE/AAAAAAAAAAI/AAAAAAAAAAA/wxxLTEF_TSg/w48-c-h48/photo.jpg)\"\u003e\u003c/span\u003e \u003c/span\u003e \u003cspan class\u003d\"responsive-img-hdpi\"\u003e \u003cspan class\u003d\"responsive-img author-image\" style\u003d\"background-image:url(https://lh3.ggpht.com/-ZjxMcXnTOgE/AAAAAAAAAAI/AAAAAAAAAAA/wxxLTEF_TSg/w96-c-h96/photo.jpg)\"\u003e\u003c/span\u003e \u003c/span\u003e \u003c/a\u003e   \u003cdiv class\u003d\"review-header\" data-expand-target\u003d\"\" data-reviewid\u003d\"gp:AOqpTOFkiAGXSOGUgG6NYTPDZV_b20tk2V8D8P8lnQ8Jtzb_hYeGqqibZLgVfnYPZMPxM3j-BCvaUj4YO0HKWQ\"\u003e \u003cdiv class\u003d\"review-info\"\u003e \u003cspan class\u003d\"author-name\"\u003e \u003ca href\u003d\"/store/people/details?id\u003d115501642928986858679\"\u003ejosé roberto\u003c/a\u003e  \u003c/span\u003e  \u003cspan class\u003d\"review-date\"\u003e15 de novembro de 2015\u003c/span\u003e \u003ca class\u003d\"reviews-permalink\" href\u003d\"/store/apps/details?id\u003dbr.autoweb.autocheck\u0026amp;reviewId\u003dZ3A6QU9xcFRPRmtpQUdYU09HVWdHNk5ZVFBEWlZfYjIwdGsyVjhEOFA4bG5ROEp0emJfaFllR3FxaWJaTGdWZm5ZUFpNUHhNM2otQkN2YVVqNFlPMEhLV1E\" title\u003d\"Link para esta resenha\"\u003e\u003c/a\u003e \u003cdiv class\u003d\"review-source\" style\u003d\"display:none\"\u003e\u003c/div\u003e \u003cdiv class\u003d\"review-info-star-rating\"\u003e  \u003cdiv class\u003d\"tiny-star star-rating-non-editable-container\" aria-label\u003d\"Com a classificação 2 de cinco estrelas\"\u003e \u003cdiv class\u003d\"current-rating\" jsname\u003d\"jIIjq\" style\u003d\"width: 40%;\"\u003e\u003c/div\u003e \u003c/div\u003e  \u003c/div\u003e \u003c/div\u003e \u003cdiv class\u003d\"rate-review-wrapper\"\u003e \u003cdiv class\u003d\"play-button icon-button small rate-review\" title\u003d\"Spam\" data-rating\u003d\"SPAM\"\u003e \u003cdiv class\u003d\"icon spam-flag\"\u003e\u003c/div\u003e \u003c/div\u003e \u003cdiv class\u003d\"play-button icon-button small rate-review\" title\u003d\"Útil\" data-rating\u003d\"HELPFUL\"\u003e \u003cdiv class\u003d\"icon thumbs-up\"\u003e\u003c/div\u003e \u003c/div\u003e \u003cdiv class\u003d\"play-button icon-button small rate-review\" title\u003d\"Não ajudou\" data-rating\u003d\"UNHELPFUL\"\u003e \u003cdiv class\u003d\"icon thumbs-down\"\u003e\u003c/div\u003e \u003c/div\u003e \u003c/div\u003e \u003c/div\u003e \",1]]'
    __EXPECTED_RESULT = '[<div class=\"review-body\"> <span class=\"review-title\">Galaxy S5</span> Paro de funcionar novamente no Estado do Parana <div class=\"review-link\" style=\"display:none\"> <a class=\"id-no-nav play-button tiny\" href=\"#\" target=\"_blank\">Resenha completa</a> </div> </div>]'

    def test_can_parse_a_google_play_response(self):
        """
        Should be able to parse a response string from a google play post request
            Hint: If this set of rules does not apply anymore means that google changed the way it responds to a
                  review page request at play store.
        """
        parser = GooglePlayResponseParser(self.__CURRENT_RESPONSE_FORMAT)
        parsed = parser.parseResponse()
        print(parsed)
        print(self.__EXPECTED_RESULT)
        self.assertEqual(parsed, self.__EXPECTED_RESULT, "The parser is broken. Fix it now!")
